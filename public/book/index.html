<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lapa Casa ‚Äî Reservas</title>
<meta name="description" content="Reserva camas, bloquea un HOLD y paga con Stripe o Mercado Pago."/>
<style>
  :root{--brand:#F03DDB;--fg:#111827;--muted:#6b7280;--line:#e5e7eb;--ok:#16a34a;--bad:#ef4444;--warn:#f59e0b;--radius:14px;--shadow:0 10px 20px rgba(0,0,0,.06)}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--fg);background:linear-gradient(180deg,#fff,#fff8fb)}
  header,footer{border-color:var(--line)}
  header{border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff,#fff8fb)} .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px}.logo{font-weight:900}.muted{color:var(--muted)}
  main{padding:18px 16px}.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)} .pad{padding:18px}
  label{display:block;margin:.4rem 0 .2rem 0;font-weight:600} input,select{width:100%;padding:.6rem;border:1px solid var(--line);border-radius:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-block;padding:10px 14px;border-radius:12px;background:var(--brand);color:#fff;font-weight:800;text-decoration:none;border:0;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--fg);border:1px solid var(--line)}
  .msg{border-radius:10px;padding:10px;margin:10px 0 0 0;font-weight:600}
  .ok{background:#ecfdf5;border:1px solid #86efac;color:#065f46}.bad{background:#fef2f2;border:1px solid #fecaca;color:#7f1d1d}.warn{background:#fff7ed;border:1px solid #fdba74;color:#7c2d12}
  .beds{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}
  .bed{padding:8px;border:1px solid var(--line);border-radius:10px;text-align:center;cursor:pointer;user-select:none}
  .bed.busy{background:#f3f4f6;color:#9ca3af;cursor:not-allowed}
  .bed.sel{outline:2px solid var(--brand);font-weight:800}
  .room{margin:10px 0 0 0;border-top:1px dashed var(--line);padding-top:10px}
  .tag{display:inline-block;background:#f3f4f6;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:.9rem;margin-right:6px}
  .flex{display:flex;gap:10px;flex-wrap:wrap}
  .right .card+.card{margin-top:16px}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="wrap top">
    <div class="logo">üè† Lapa Casa Hostel</div>
    <nav class="flex">
      <a class="btn ghost" href="/">Home</a>
      <a class="btn" href="/pago-exitoso-test/">Pago</a>
      <a class="btn ghost" href="/admin/">Admin</a>
    </nav>
  </div>
</header>

<main>
  <div class="wrap grid">
    <!-- Columna izquierda: Formulario -->
    <section class="card left">
      <div class="pad">
        <h2 style="margin:0 0 8px 0">Reservar</h2>
        <p class="muted" style="margin:0 0 10px 0">Eleg√≠ fechas, camas, bloque√° un <b>HOLD</b> y pag√°.</p>

        <form id="form">
          <div class="row">
            <div>
              <label for="entrada">Entrada</label>
              <input id="entrada" name="entrada" type="date" required />
            </div>
            <div>
              <label for="salida">Salida</label>
              <input id="salida" name="salida" type="date" required />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="nombre">Nombre</label>
              <input id="nombre" name="nombre" placeholder="Nombre y apellido" required />
            </div>
            <div>
              <label for="email">Email</label>
              <input id="email" name="email" type="email" placeholder="tucorreo@dominio.com" required />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="hombres">Hombres</label>
              <input id="hombres" name="hombres" type="number" min="0" value="1"/>
            </div>
            <div>
              <label for="mujeres">Mujeres</label>
              <input id="mujeres" name="mujeres" type="number" min="0" value="0"/>
            </div>
          </div>

          <div class="room">
            <div class="flex" style="align-items:center;justify-content:space-between">
              <strong>Camas por cuarto</strong>
              <span class="muted" id="legend">Ocupadas: gris ¬∑ Libres: blanco ¬∑ Selecci√≥n: borde rosa</span>
            </div>
            <div id="rooms"></div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="total">Total (BRL)</label>
              <input id="total" name="total" type="number" min="0" value="0" />
            </div>
            <div>
              <label>&nbsp;</label>
              <div class="flex">
                <button type="button" id="btnHold" class="btn">üîí HOLD</button>
                <button type="button" id="btnRelease" class="btn ghost">Liberar HOLD</button>
              </div>
            </div>
          </div>

          <div id="holdMsg" class="msg warn" style="display:none"></div>

          <div class="flex" style="margin-top:12px">
            <button type="button" id="payStripe" class="btn">üí≥ Pagar con Stripe</button>
            <button type="button" id="payMP" class="btn ghost">‚ö° Mercado Pago</button>
            <button type="submit" class="btn ghost">Guardar en Sheets</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Columna derecha: Disponibilidad y resumen -->
    <aside class="right">
      <section class="card">
        <div class="pad">
          <h3 style="margin:0 0 8px 0">Disponibilidad</h3>
          <div id="avail" class="muted">‚Äî</div>
        </div>
      </section>

      <section class="card">
        <div class="pad">
          <h3 style="margin:0 0 8px 0">Resumen</h3>
          <div id="summary" class="muted">Complet√° el formulario‚Ä¶</div>
        </div>
      </section>
    </aside>
  </div>
</main>

<footer>
  <div class="wrap" style="text-align:center;padding:16px">¬© Lapa Casa Hostel ‚Äî Santa Teresa, RJ</div>
</footer>

<script>
(() => {
  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>Array.from(document.querySelectorAll(q));
  const fmtBeds = (arr)=> (arr && arr.length)? arr.join(", ") : "‚Äî";
  const CAPACITY = { "1":12, "3":12, "5":7, "6":7 }; // ajustar si cambia

  // Estado simple
  const state = {
    occupied: {"1":[],"3":[],"5":[],"6":[]},
    selected: {"1":[],"3":[],"5":[],"6":[]},
    holdId: null,
    holdExpiresAt: null
  };

  // Init fechas
  const d = new Date(); d.setDate(d.getDate()+3);
  $("#entrada").value = d.toISOString().slice(0,10);
  d.setDate(d.getDate()+3);
  $("#salida").value = d.toISOString().slice(0,10);

  // Render resumen
  function renderSummary(){
    const sel = Object.entries(state.selected)
      .filter(([_,a])=>a.length)
      .map(([r,a])=>`Cuarto ${r}: ${fmtBeds(a)}`).join(" ¬∑ ");
    $("#summary").innerHTML = `
      <div class="tag">Entrada: ${$("#entrada").value}</div>
      <div class="tag">Salida: ${$("#salida").value}</div>
      <div class="tag">H: ${$("#hombres").value} ¬∑ M: ${$("#mujeres").value}</div>
      <div style="margin-top:6px">${ sel || '<span class="muted">Sin camas seleccionadas</span>' }</div>
      <div class="muted" style="margin-top:6px">Total BRL: <b>${Number($("#total").value||0)}</b></div>
    `;
  }

  // Render disponibilidad + selectores de cama
  function renderRooms(){
    const cont = $("#rooms"); cont.innerHTML = "";
    Object.keys(CAPACITY).forEach(roomId=>{
      const total = CAPACITY[roomId];
      const occ = new Set(state.occupied[roomId] || []);
      const sel = new Set(state.selected[roomId] || []);
      const wrap = document.createElement("div");
      wrap.innerHTML = `<div class="muted" style="margin:8px 0 4px 0"><b>Cuarto ${roomId}</b> ¬∑ Ocupadas: ${occ.size} / ${total}</div>`;
      const grid = document.createElement("div"); grid.className = "beds";
      for (let n=1;n<=total;n++){
        const div = document.createElement("div");
        const busy = occ.has(n);
        const selected = sel.has(n);
        div.className = "bed" + (busy? " busy":"") + (selected? " sel": "");
        div.textContent = n;
        if (!busy){
          div.addEventListener("click", ()=>{
            const arr = state.selected[roomId] || [];
            const i = arr.indexOf(n);
            if (i>=0) arr.splice(i,1); else arr.push(n);
            state.selected[roomId] = arr.sort((a,b)=>a-b);
            renderRooms(); renderSummary();
          });
        }
        grid.appendChild(div);
      }
      wrap.appendChild(grid);
      cont.appendChild(wrap);
    });
  }

  async function fetchAvailability(){
    const from = $("#entrada").value, to = $("#salida").value;
    $("#avail").textContent = "Cargando‚Ä¶";
    try{
      const r = await fetch(`/api/availability?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      const j = await r.json();
      if (!j.ok) throw new Error("availability_error");
      state.occupied = j.occupied || state.occupied;
      $("#avail").innerHTML = Object.keys(CAPACITY).map(roomId=>{
        const total = CAPACITY[roomId]; const occ = (state.occupied[roomId]||[]).length;
        return `<div class="tag">Cuarto ${roomId}: libres ${Math.max(total-occ,0)}</div>`;
      }).join(" ");
      renderRooms();
    }catch{
      $("#avail").textContent = "No disponible.";
    }
  }

  function camasPayload(){
    const out={}; Object.keys(state.selected).forEach(r=>{
      if ((state.selected[r]||[]).length) out[r] = state.selected[r];
    });
    return out;
  }

  function setHoldMsg(kind, text){
    const box = $("#holdMsg");
    box.style.display = "block";
    box.className = "msg " + (kind||"warn");
    box.textContent = text;
  }

  async function startHold(){
    const p = {
      entrada: $("#entrada").value,
      salida: $("#salida").value,
      nombre: $("#nombre").value,
      email: $("#email").value,
      hombres: Number($("#hombres").value||0),
      mujeres: Number($("#mujeres").value||0),
      camas: camasPayload(),
      total: Number($("#total").value||0),
      ttlMinutes: 10
    };
    if (!Object.keys(p.camas).length) { setHoldMsg("bad","Eleg√≠ al menos una cama."); return; }
    try{
      const r = await fetch("/api/holds/start", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(p) });
      const j = await r.json();
      if (j.ok){
        state.holdId = j.holdId; state.holdExpiresAt = j.expiresAt;
        setHoldMsg("ok", `HOLD activo (#${state.holdId}). Expira: ${new Date(j.expiresAt).toLocaleTimeString()}`);
      } else throw new Error(j.error||"hold_failed");
    }catch(e){ setHoldMsg("bad","No se pudo iniciar HOLD."); }
    await fetchAvailability();
  }

  async function releaseHold(){
    if (!state.holdId) { setHoldMsg("warn","No hay HOLD activo."); return; }
    try{
      const r = await fetch("/api/holds/release", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ holdId: state.holdId })});
      const j = await r.json();
      if (j.ok){ setHoldMsg("warn","HOLD liberado."); state.holdId=null; state.holdExpiresAt=null; }
      else throw new Error();
    }catch{ setHoldMsg("bad","No se pudo liberar HOLD."); }
    await fetchAvailability();
  }

  // Guardar/Upsert directo a Sheets v√≠a backend
  async function upsertBooking(status="pending"){
    const payload = {
      bookingId: state.holdId || `BKG-${Date.now()}`,
      entrada: $("#entrada").value,
      salida:  $("#salida").value,
      nombre:  $("#nombre").value,
      email:   $("#email").value,
      hombres: Number($("#hombres").value||0),
      mujeres: Number($("#mujeres").value||0),
      camas:   camasPayload(),
      total:   Number($("#total").value||0),
      pay_status: status
    };
    const r = await fetch("/api/bookings", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
    const j = await r.json(); if (!j.ok) throw new Error(j.error||"bookings_error");
    return payload.bookingId;
  }

  async function payStripe(){
    try{
      const bid = await upsertBooking("hold");
      const total = Number($("#total").value||0);
      const r = await fetch("/payments/stripe/session", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ order:{ booking_id: bid, total } })
      });
      const j = await r.json();
      if (j && (j.url || j.id)){
        location.href = j.url || `/pago-exitoso-test/?provider=stripe&session_id=${encodeURIComponent(j.id)}&booking_id=${encodeURIComponent(bid)}&status=success`;
      } else throw new Error();
    }catch{ setHoldMsg("bad","Stripe: no se pudo crear sesi√≥n."); }
  }

  async function payMP(){
    try{
      const bid = await upsertBooking("hold");
      const total = Number($("#total").value||0);
      const r = await fetch("/payments/mp/preference", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ order:{ booking_id: bid, total } })
      });
      const j = await r.json();
      if (j && j.init_point) location.href = j.init_point;
      else throw new Error();
    }catch{ setHoldMsg("bad","Mercado Pago: no se pudo crear preferencia."); }
  }

  // Listeners
  $("#entrada").addEventListener("change", fetchAvailability);
  $("#salida").addEventListener("change", fetchAvailability);
  ["hombres","mujeres","total","nombre","email"].forEach(id=> $("#"+id).addEventListener("input", renderSummary));
  $("#btnHold").addEventListener("click", startHold);
  $("#btnRelease").addEventListener("click", releaseHold);
  $("#payStripe").addEventListener("click", payStripe);
  $("#payMP").addEventListener("click", payMP);

  $("#form").addEventListener("submit", async (e)=>{
    e.preventDefault();
    try{ await upsertBooking("pending"); setHoldMsg("ok","Reserva guardada en Sheets."); }
    catch{ setHoldMsg("bad","No se pudo guardar."); }
  });

  // Primera carga
  renderSummary();
  fetchAvailability();
})();
</script>
</body>
</html>
