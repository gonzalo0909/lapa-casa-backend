<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Reservas — Lapa Casa</title>
<meta name="description" content="Reserva en Lapa Casa Hostel (formulario, disponibilidad y pago)."/>
<style>
  :root{--brand:#F03DDB;--fg:#111827;--muted:#6b7280;--line:#e5e7eb;--bg:#fafafa;--r:14px;--max:1000px}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--fg);background:var(--bg)}
  header{padding:18px 16px;background:linear-gradient(180deg,#fff,#fff8fb);border-bottom:1px solid var(--line)}
  .wrap{max-width:var(--max);margin:0 auto}
  h1{margin:0;font-size:clamp(22px,4vw,28px)}
  main{padding:22px 16px}
  .grid{display:grid;gap:16px;grid-template-columns:1fr;align-items:start}
  @media(min-width:900px){.grid{grid-template-columns:420px 1fr}}
  .card{background:#fff;border:1px solid var(--line);border-radius:var(--r);padding:16px}
  label{display:block;margin-bottom:12px}
  input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
  .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)} .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .msg{margin-top:10px;font-weight:600}
  table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
  .right{text-align:right}
</style>
</head>
<body>
<header><div class="wrap">
  <h1>Reservas</h1>
  <p class="muted">Elegí fechas, completa tus datos y pagá con Stripe o Mercado Pago.</p>
</div></header>

<main><div class="wrap">
  <div class="grid">
    <!-- FORMULARIO -->
    <section class="card">
      <h2 style="margin:4px 0 12px 0">Tu reserva</h2>
      <form id="bookingForm">
        <input type="hidden" name="bookingId" id="bookingId"/>

        <label>Nombre
          <input id="nombre" name="nombre" required placeholder="Tu nombre"/>
        </label>
        <label>Email
          <input id="email" name="email" type="email" required placeholder="tu@email.com"/>
        </label>
        <div class="row">
          <label>Entrada
            <input id="entrada" name="entrada" type="date" required/>
          </label>
          <label>Salida
            <input id="salida" name="salida" type="date" required/>
          </label>
        </div>
        <div class="row">
          <label>Hombres
            <input id="hombres" name="hombres" type="number" min="0" value="1"/>
          </label>
          <label>Mujeres
            <input id="mujeres" name="mujeres" type="number" min="0" value="0"/>
          </label>
        </div>
        <label>Total (BRL)
          <input id="total" name="total" type="number" min="0" step="1" placeholder="Ej: 300" required/>
        </label>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn" id="btnGuardar" type="submit">Guardar reserva</button>
          <button class="btn ghost" id="btnStripe" type="button" disabled>Pago con tarjeta (Stripe)</button>
          <button class="btn ghost" id="btnMP" type="button" disabled>Pago con Mercado Pago</button>
        </div>
        <div id="formMsg" class="msg muted"></div>
      </form>
    </section>

    <!-- DISPONIBILIDAD -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h2 style="margin:4px 0">Disponibilidad</h2>
        <span class="pill" id="rangePill">—</span>
      </div>
      <p class="muted" style="margin-top:-4px">Vista rápida por cuarto (ocupadas vs libres).</p>
      <table id="availTbl">
        <thead><tr><th>Cuarto</th><th>Ocupadas</th><th>Libres</th><th class="right">Camas ocupadas</th></tr></thead>
        <tbody></tbody>
      </table>
      <div id="availMsg" class="msg muted"></div>
    </section>
  </div>
</div></main>

<footer style="text-align:center;padding:18px;border-top:1px solid var(--line);background:#fff">
  © Lapa Casa Hostel — Santa Teresa, RJ
</footer>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const form = $("bookingForm");
  const btnStripe = $("btnStripe");
  const btnMP = $("btnMP");
  const btnGuardar = $("btnGuardar");
  const formMsg = $("formMsg");
  const rangePill = $("rangePill");
  const availTbody = document.querySelector("#availTbl tbody");
  const availMsg = $("availMsg");

  // genera/recupera bookingId para amarrar pago
  const initialBkg = (new URLSearchParams(location.search)).get("booking_id");
  const bookingId = initialBkg || `BKG-${Date.now()}`;
  $("bookingId").value = bookingId;

  // fechas mínimas
  const today = new Date().toISOString().slice(0,10);
  $("entrada").value = today;
  $("salida").value = today;
  $("entrada").addEventListener("change", syncDates);
  $("salida").addEventListener("change", syncDates);
  function syncDates(){
    const a = $("entrada").value, b = $("salida").value;
    if (a && b && a>b) $("salida").value = a;
    renderAvailability();
  }

  // disponibilidad
  async function renderAvailability(){
    const from = $("entrada").value, to = $("salida").value;
    if (!from || !to) return;
    rangePill.textContent = `${from} → ${to}`;
    availTbody.innerHTML = `<tr><td colspan="4" class="muted">Cargando…</td></tr>`;
    try{
      const r = await fetch(`/api/availability?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`);
      const j = await r.json();
      if (!j.ok) throw new Error(j.error||"availability_failed");
      const CAP = { "1":12, "3":12, "5":7, "6":7 };
      const rows = [];
      for (const roomId of Object.keys(CAP)){
        const occ = j.occupied?.[roomId] || [];
        const total= CAP[roomId];
        rows.push(`<tr>
          <td>#${roomId}</td>
          <td>${occ.length}/${total}</td>
          <td>${Math.max(total-occ.length,0)}</td>
          <td class="right">${occ.length? occ.join(", ") : "—"}</td>
        </tr>`);
      }
      availTbody.innerHTML = rows.join("") || `<tr><td colspan="4">Sin datos</td></tr>`;
      availMsg.textContent = "";
    }catch(e){
      availTbody.innerHTML = `<tr><td colspan="4">No disponible</td></tr>`;
      availMsg.textContent = "No se pudo obtener disponibilidad.";
    }
  }
  renderAvailability();

  // guardar / upsert (no paga todavía)
  form.addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    btnGuardar.disabled = true; formMsg.textContent = "Guardando…";
    const payload = {
      booking_id: $("bookingId").value,
      nombre: $("nombre").value.trim(),
      email: $("email").value.trim(),
      entrada: $("entrada").value,
      salida:  $("salida").value,
      hombres: Number($("hombres").value || 0),
      mujeres: Number($("mujeres").value || 0),
      total:   Number($("total").value || 0),
      pay_status: "pending",
      camas:{} // sin selección de cama en esta versión
    };
    try{
      const r = await fetch("/api/bookings", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error||"save_failed");
      formMsg.textContent = "✅ Reserva guardada. Elegí método de pago.";
      btnStripe.disabled = false;
      btnMP.disabled = false;
    }catch(e){
      formMsg.textContent = "❌ Error: " + (e.message || "no se pudo guardar");
    }finally{
      btnGuardar.disabled = false;
    }
  });

  // pago Stripe
  btnStripe.addEventListener("click", async ()=>{
    btnStripe.disabled = true; formMsg.textContent = "Creando pago (Stripe)…";
    const order = {
      booking_id: $("bookingId").value,
      total: Number($("total").value || 0),
      email: $("email").value.trim(),
      nights: nightsDiff($("entrada").value, $("salida").value)
    };
    try{
      const r = await fetch("/payments/stripe/session", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ order })
      });
      const j = await r.json();
      if (!j.ok && !j.url) throw new Error(j.error||"stripe_failed");
      location.href = j.url || `/pago-exitoso-test?provider=stripe&booking_id=${encodeURIComponent(order.booking_id)}`;
    }catch(e){
      formMsg.textContent = "❌ Stripe: " + (e.message||"error");
      btnStripe.disabled = false;
    }
  });

  // pago Mercado Pago
  btnMP.addEventListener("click", async ()=>{
    btnMP.disabled = true; formMsg.textContent = "Creando pago (Mercado Pago)…";
    const order = {
      booking_id: $("bookingId").value,
      total: Number($("total").value || 0)
    };
    try{
      const r = await fetch("/payments/mp/preference", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ order })
      });
      const j = await r.json();
      if (!j.ok && !j.init_point) throw new Error(j.error||"mp_failed");
      // redirige a MP
      location.href = j.init_point;
    }catch(e){
      formMsg.textContent = "❌ Mercado Pago: " + (e.message||"error");
      btnMP.disabled = false;
    }
  });

  function nightsDiff(a,b){
    if(!a||!b) return 1;
    const d1=new Date(a+"T00:00:00Z"), d2=new Date(b+"T00:00:00Z");
    const n=Math.max(1,Math.round((d2-d1)/(1000*60*60*24)));
    return n;
  }
})();
</script>
</body>
</html>
