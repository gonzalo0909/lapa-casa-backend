<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Lapa Casa</title>
  <style>
    :root{--line:#e5e7eb;--muted:#6b7280;--brand:#F03DDB}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,Arial,sans-serif;background:#fff}
    header{padding:16px;border-bottom:1px solid var(--line)} h1{margin:0;font-size:20px}
    main{max-width:980px;margin:0 auto;padding:16px}
    .card{border:1px solid var(--line);border-radius:12px}
    .pad{padding:16px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    label{font-weight:600;font-size:14px} input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
    .btn{display:inline-flex;gap:8px;align-items:center;border:0;padding:10px 14px;border-radius:10px;background:var(--brand);color:#fff;cursor:pointer}
    .btn.ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .muted{color:var(--muted)} pre{white-space:pre-wrap;background:#fafafa;border:1px solid var(--line);border-radius:10px;padding:12px}
    table{width:100%;border-collapse:collapse;font-size:14px} th,td{border:1px solid var(--line);padding:8px;text-align:left}
    .hide{display:none}
  </style>
</head>
<body>
  <header><h1>Admin — Lapa Casa</h1><div class="muted">Login simple con sesión (cookie-session)</div></header>
  <main>
    <!-- LOGIN -->
    <section id="loginBox" class="card">
      <div class="pad">
        <h3 style="margin:0 0 8px 0">Iniciar sesión</h3>
        <div class="row">
          <div><label>Usuario</label><input id="user" autocomplete="username" /></div>
          <div><label>Contraseña</label><input id="pass" type="password" autocomplete="current-password" /></div>
        </div>
        <div style="margin-top:12px;display:flex;gap:10px">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnDiag" class="btn ghost">Ver /api/diag</button>
        </div>
        <div id="loginMsg" class="muted" style="margin-top:10px"></div>
        <pre id="diagBox" class="hide"></pre>
      </div>
    </section>

    <!-- PANEL -->
    <section id="panelBox" class="card hide" style="margin-top:16px">
      <div class="pad">
        <h3 style="margin:0 0 8px 0">Panel</h3>
        <div class="muted">Sesión activa. Usá los atajos:</div>
        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
          <button id="btnShowDiag" class="btn ghost">/api/diag</button>
          <button id="btnList" class="btn">Listar reservas</button>
          <button id="btnLogout" class="btn ghost">Salir</button>
        </div>
        <div id="panelMsg" class="muted" style="margin-top:10px"></div>
        <pre id="panelDiag" class="hide"></pre>
        <div id="listWrap" class="hide" style="margin-top:10px;overflow:auto;max-height:60vh"></div>
      </div>
    </section>
  </main>

  <script>
    const $ = (s)=>document.querySelector(s);
    const loginBox = $("#loginBox"), panelBox = $("#panelBox");
    const loginMsg = $("#loginMsg"), diagBox = $("#diagBox");
    const panelMsg = $("#panelMsg"), panelDiag = $("#panelDiag"), listWrap = $("#listWrap");

    async function json(url, opt){ const r=await fetch(url, opt||{}); const t=await r.text(); try{ return {ok:r.ok, code:r.status, data:JSON.parse(t)} }catch{ return {ok:r.ok, code:r.status, data:t} } }

    // Login
    $("#btnLogin").addEventListener("click", async ()=>{
      loginMsg.textContent = "Ingresando…";
      const body = { user: $("#user").value, pass: $("#pass").value };
      const r = await json("/admin/login", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      if (r.ok && r.data && r.data.ok){
        loginMsg.textContent = "OK. Cargando panel…";
        loginBox.classList.add("hide"); panelBox.classList.remove("hide");
      } else {
        loginMsg.textContent = "Credenciales inválidas.";
      }
    });

    // Ver diag sin login
    $("#btnDiag").addEventListener("click", async ()=>{
      const r = await json("/api/diag");
      diagBox.classList.remove("hide");
      diagBox.textContent = JSON.stringify(r.data, null, 2);
    });

    // Panel: diag
    $("#btnShowDiag").addEventListener("click", async ()=>{
      panelMsg.textContent = "Cargando /api/diag…";
      const r = await json("/api/diag"); panelMsg.textContent="";
      panelDiag.classList.remove("hide");
      panelDiag.textContent = JSON.stringify(r.data, null, 2);
    });

    // Panel: listar reservas (usa /api/bookings del backend)
    $("#btnList").addEventListener("click", async ()=>{
      panelMsg.textContent = "Leyendo reservas…";
      const r = await json("/api/bookings"); panelMsg.textContent="";
      const rows = (r.data && r.data.rows) ? r.data.rows.slice(-50).reverse() : [];
      if (!rows.length){ listWrap.classList.remove("hide"); listWrap.innerHTML = "<div class='muted'>Sin datos.</div>"; return; }
      // render tabla simple
      const headers = Object.keys(rows[0]);
      let html = "<table><thead><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr></thead><tbody>";
      for (const row of rows){
        html += "<tr>"+headers.map(h=>`<td>${row[h] ?? ""}</td>`).join("")+"</tr>";
      }
      html += "</tbody></table>";
      listWrap.classList.remove("hide");
      listWrap.innerHTML = html;
    });

    // Logout
    $("#btnLogout").addEventListener("click", async ()=>{
      await json("/admin/logout", { method:"POST" });
      location.reload();
    });

    // Si ya hay sesión, mostramos panel (petición a /admin/ devuelve 200 si pasa guardia)
    (async function autoCheck(){
      try{
        const r = await fetch("/admin/", { method:"GET" });
        if (r.status===200){ loginBox.classList.add("hide"); panelBox.classList.remove("hide"); }
      }catch{}
    })();
  </script>
</body>
</html>
