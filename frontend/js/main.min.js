"use strict";console.log("Loading main.js with bunk bed layout");const ROOMS={1:12,3:12,5:7,6:7},PRICE_PER_NIGHT=55;let holdTimer=null,holdTimeLeft=0;const roomsCard=document.getElementById("roomsCard"),formCard=document.getElementById("formCard"),rateLimiter={requests:new Map,maxRequests:5,timeWindow:6e4,canMakeRequest(e){const t=Date.now(),n=this.requests.get(e)||[],a=n.filter(e=>t-e<this.timeWindow);return a.length<this.maxRequests&&(a.push(t),this.requests.set(e,a),!0)}};function calcNights(e,t){const n=new Date(e),a=new Date(t),r=a-n;return r>0?Math.ceil(r/864e5):1}function validateAndSanitizeForm(){let e=!0;const t=document.getElementById("nombre"),n=document.getElementById("nombreError");if(t&&n){const a=sanitizeInput(t.value);if(t.value=a,!a||a.length<2)n.textContent="Nombre debe tener al menos 2 caracteres",n.classList.remove("hidden"),e=!1;else if(!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(a))n.textContent="Nombre solo puede contener letras y espacios",n.classList.remove("hidden"),e=!1;else n.classList.add("hidden")}const a=document.getElementById("email"),r=document.getElementById("emailError");if(a&&r){const t=sanitizeInput(a.value).toLowerCase();a.value=t;const n=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;t&&n.test(t)?r.classList.add("hidden"):(r.textContent="Email inválido",r.classList.remove("hidden"),e=!1)}const i=document.getElementById("telefono"),o=document.getElementById("telefonoError");if(i&&o){const t=sanitizeInput(i.value);i.value=t;const n=/^[0-9+\-\s\(\)]{10,}$/;t&&n.test(t)?o.classList.add("hidden"):(o.textContent="Teléfono debe tener al menos 10 caracteres válidos",o.classList.remove("hidden"),e=!1)}return e}function showError(e){const t=document.getElementById("errorToast"),n=document.getElementById("errorMessage");t&&n&&(n.textContent=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),5e3))}function showSuccess(e){const t=document.getElementById("successToast"),n=document.getElementById("successMessage");t&&n&&(n.textContent=e,t.classList.remove("hidden"),setTimeout(()=>t.classList.add("hidden"),5e3))}function startHoldTimer(e=10){holdTimeLeft=60*e;const t=document.getElementById("paymentTimer"),n=document.getElementById("timerDisplay");t&&(t.style.display="block"),holdTimer=setInterval(()=>{if(holdTimeLeft--,n){const e=Math.floor(holdTimeLeft/60),t=holdTimeLeft%60;n.textContent=`${e}:${t.toString().padStart(2,"0")}`}holdTimeLeft<=0&&(clearInterval(holdTimer),t&&(t.style.display="none"),showError("Hold expirado. Selecciona nuevamente tus camas."))},1e3)}function stopHoldTimer(){holdTimer&&(clearInterval(holdTimer),holdTimer=null);const e=document.getElementById("paymentTimer");e&&(e.style.display="none")}function updateCalculations(){const e=parseInt(document.getElementById("men").value||0,10),t=parseInt(document.getElementById("women").value||0,10),n=e+t;document.getElementById("needed").textContent=n;const a=document.getElementById("dateIn").value,r=document.getElementById("dateOut").value;if(a&&r){const e=calcNights(a,r),t=n*e*PRICE_PER_NIGHT;document.getElementById("totalPrice").textContent=t;const i=document.getElementById("progressFill");if(i&&n>0){const e=document.querySelectorAll(".bed.selected").length,t=e/n*100;i.style.width=`${Math.min(t,100)}%`}}}function getBedLevel(e){const t=e%3;return 1===t?"Baja":2===t?"Media":"Alta"}function getBedOrderForDisplay(e){const t=[];if(12===e)for(let e=3;e>=1;e--)for(let n=0;n<4;n++){const a=3*n+e;t.push(a)}else if(7===e){for(let e=3;e>=1;e--)for(let n=0;n<2;n++){const a=3*n+e;t.push(a)}t.push(7)}return t}function addRoom(e,t,n,a){const r=document.createElement("div");r.className="room",r.dataset.room=t,r.innerHTML=`<h3>Habitación ${t} (${n})</h3><div class="beds"></div>`;const i=r.querySelector(".beds"),o=ROOMS[t],s=getBedOrderForDisplay(o);return s.forEach(e=>{const n=document.createElement("div");n.className="bed",n.dataset.room=t,n.dataset.bed=e;const a=getBedLevel(e);n.innerHTML=`\n      <div class="bed-number">Cama ${e}</div>\n      <div class="bed-level">(${a})</div>\n    `,i.appendChild(n)}),e.appendChild(r),r}function updateRoomDisplay(){const e=parseInt(document.getElementById("men").value||0,10),t=parseInt(document.getElementById("women").value||0,10),n=e+t;if(0===n)return document.getElementById("rooms").innerHTML="",void(roomsCard.style.display="none");roomsCard.style.display="block";const a=document.getElementById("rooms");a.innerHTML="",n>0&&(addRoom(a,1,"Mixta",n),addRoom(a,5,"Mixta",n)),n>12&&a.querySelector('[data-room="1"]').after(addRoom(document.createElement("div"),3,"Mixta",n).children[0]),t>0?addRoom(a,6,"Solo mujeres",n).appendChild(Object.assign(document.createElement("div"),{className:"warning",textContent:"Este cuarto es exclusivo para mujeres."})):e>31&&addRoom(a,6,"Emergencia (hombres)",n).appendChild(Object.assign(document.createElement("div"),{className:"warning",textContent:"Uso excepcional para capacidad extra de hombres."}))}function validateAdminToken(){const e=document.getElementById("admToken"),t=document.getElementById("tokenError");if(!e||!t)return!1;const n=e.value.trim();return n?(n.length<8?(t.textContent="Token debe tener al menos 8 caracteres",t.classList.remove("hidden"),!1):(t.classList.add("hidden"),!0)):(t.textContent="Token requerido",t.classList.remove("hidden"),!1)}function sanitizeInput(e){return"string"!=typeof e?e:e.trim().replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").replace(/script/gi,"").substring(0,200)}async function performAdminAction(e,t,n=null){if(!validateAdminToken())return void showError("Token inválido");if(!rateLimiter.canMakeRequest("admin"))return void showError("Demasiadas consultas admin. Espera 1 minuto.");const a=document.getElementById("admToken").value.trim();try{const r={method:n?"POST":"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`,"X-Admin-Token":a}};n&&(r.body=JSON.stringify(n));const i=await fetch(`${window.HOSTEL_CONFIG.API_BASE}${t}`,r);if(401===i.status||403===i.status)return showError("Token inválido o sin permisos"),null;if(!i.ok)throw new Error(`Error ${i.status}: ${i.statusText}`);return await i.json()}catch(t){return console.error(`Error in ${e}:`,t),showError(`Error en ${e}: ${t.message}`),null}}document.addEventListener("DOMContentLoaded",function(){if(console.log("DOM loaded - setting up bunk bed controls"),"https:"!==location.protocol&&"localhost"!==location.hostname&&"127.0.0.1"!==location.hostname)return console.warn("Redirigiendo a HTTPS..."),void location.replace(`https:${location.href.substring(location.protocol.length)}`);const e=new Date().toISOString().split("T")[0],t=document.getElementById("dateIn"),n=document.getElementById("dateOut");t&&(t.min=e),n&&(n.min=e);const a=document.getElementById("menPlus"),r=document.getElementById("menMinus"),i=document.getElementById("womenPlus"),o=document.getElementById("womenMinus");a?a.addEventListener("click",function(){console.log("Men plus clicked");try{const e=document.getElementById("men");if(!e)throw new Error("Men input not found");const t=parseInt(e.value||0,10);e.value=Math.min(38,t+1),updateCalculations(),updateRoomDisplay()}catch(e){console.error("Error in men plus:",e)}}):console.warn("Men plus button not found"),r?r.addEventListener("click",function(){console.log("Men minus clicked");try{const e=document.getElementById("men");if(!e)throw new Error("Men input not found");const t=parseInt(e.value||0,10);e.value=Math.max(0,t-1),updateCalculations(),updateRoomDisplay()}catch(e){console.error("Error in men minus:",e)}}):console.warn("Men minus button not found"),i?i.addEventListener("click",function(){console.log("Women plus clicked");try{const e=document.getElementById("women");if(!e)throw new Error("Women input not found");const t=parseInt(e.value||0,10);e.value=Math.min(38,t+1),updateCalculations(),updateRoomDisplay()}catch(e){console.error("Error in women plus:",e)}}):console.warn("Women plus button not found"),o?o.addEventListener("click",function(){console.log("Women minus clicked");try{const e=document.getElementById("women");if(!e)throw new Error("Women input not found");const t=parseInt(e.value||0,10);e.value=Math.max(0,t-1),updateCalculations(),updateRoomDisplay()}catch(e){console.error("Error in women minus:",e)}}):console.warn("Women minus button not found");const s=document.getElementById("checkAvail");s&&s.addEventListener("click",function(){if(console.log("Check availability clicked"),!rateLimiter.canMakeRequest("availability"))return void showError("Demasiadas consultas. Espera 1 minuto.");const e=document.getElementById("dateIn").value,t=document.getElementById("dateOut").value;if(!e||!t)return void alert("Seleccioná fechas");const n=s.querySelector(".btn-text"),a=s.querySelector(".btn-loading");n&&a&&(n.classList.add("hidden"),a.classList.remove("hidden"),s.disabled=!0),setTimeout(()=>{n&&a&&(n.classList.remove("hidden"),a.classList.add("hidden"),s.disabled=!1)},2e3),console.log("Availability check disabled for testing")});const l=document.getElementById("rooms");l&&l.addEventListener("click",function(e){const t=e.target.closest(".bed");if(!t||t.classList.contains("occupied"))return;t.classList.toggle("selected");const n=document.querySelectorAll(".bed.selected").length;document.getElementById("selCount").textContent=n;const a=parseInt(document.getElementById("men").value||0,10)+parseInt(document.getElementById("women").value||0,10),r=document.getElementById("progressFill");if(r&&a>0){const e=n/a*100;r.style.width=`${Math.min(e,100)}%`}const i=document.getElementById("continueBtn");i&&(i.disabled=n!==a,n===a&&a>0?(startHoldTimer(3),showSuccess("Camas reservadas temporalmente por 3 minutos")):stopHoldTimer())});const c=document.getElementById("admToken");c&&c.addEventListener("blur",validateAdminToken);const d=document.getElementById("btnHealth"),m=document.getElementById("btnHolds"),u=document.getElementById("btnBookings");d&&d.addEventListener("click",async function(){const e=await performAdminAction("health check","/admin/health");if(e){const t=document.getElementById("healthOut");t&&(t.textContent=JSON.stringify(e,null,2))}}),m&&m.addEventListener("click",async function(){const e=await performAdminAction("listar holds","/admin/holds");if(e){const t=document.getElementById("holdsOut");t&&(t.innerHTML=`<table><tr><th>ID</th><th>Camas</th><th>Expira</th></tr>`+e.map(e=>`<tr><td>${e.id}</td><td>${e.beds.join(",")}</td><td>${e.expires}</td></tr>`).join("")+"</table>")}}),u&&u.addEventListener("click",async function(){const e=document.getElementById("bkFrom")?.value,t=document.getElementById("bkTo")?.value,n=document.getElementById("bkQ")?.value,a=new URLSearchParams;e&&a.append("from",e),t&&a.append("to",t),n&&a.append("q",n);const r=await performAdminAction("buscar reservas",`/admin/bookings?${a}`);if(r){const e=document.getElementById("bookingsOut");e&&(e.innerHTML=`<table><tr><th>ID</th><th>Nombre</th><th>Email</th><th>Check-in</th><th>Camas</th></tr>`+r.map(e=>`<tr><td>${e.id}</td><td>${e.nombre}</td><td>${e.email}</td><td>${e.dateIn}</td><td>${e.beds.join(",")}</td></tr>`).join("")+"</table>")}});const g=document.getElementById("nombre"),h=document.getElementById("email"),p=document.getElementById("telefono");g&&g.addEventListener("blur",validateAndSanitizeForm),h&&h.addEventListener("blur",validateAndSanitizeForm),p&&p.addEventListener("blur",validateAndSanitizeForm);const v=document.getElementById("closeError"),f=document.getElementById("closeSuccess");v&&v.addEventListener("click",function(){document.getElementById("errorToast").classList.add("hidden")}),f&&f.addEventListener("click",function(){document.getElementById("successToast").classList.add("hidden")}),console.log("All event listeners attached"),updateCalculations(),updateRoomDisplay()});
